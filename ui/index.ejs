<!doctype html>
<html lang="es">

<head>
  <%- include('partials/head.html') %>
  <title><%= typeof title !== 'undefined' ? title : 'Aplicación Contenedora' %></title>
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
  <div class="min-h-screen bg-background text-foreground">
    <!-- Header -->
    <header class="header">
      <div class="header__left">
        <h1 class="header__title">Aplicaciones</h1>
      </div>
      <div class="header__right">
        <button id="toggleTheme" class="btn btn-ghost btn-icon rounded-full muted-50" aria-label="Cambiar tema">
          <span id="themeIcon" class="icon-20"></span>
        </button>

        <div class="user-menu">
          <button id="userMenuBtn"
                  class="btn btn-ghost btn-icon rounded-full primary-20"
                  aria-label="Usuario"
                  aria-haspopup="menu"
                  aria-expanded="false"
                  aria-controls="userMenu">
            <i data-lucide="user" class="icon-20 primary"></i>
          </button>

          <!-- Menú / dropdown -->
          <div id="userMenu" class="dropdown-menu auth-menu dropdown-menu--right" role="menu" hidden>
            <a class="dropdown-item" role="menuitem" href="/profile">
              <i data-lucide="settings" class="icon-16"></i> Mi perfil
            </a>
            <a class="dropdown-item danger" role="menuitem" href="/auth/logout">
              <i data-lucide="log-out" class="icon-16"></i> Cerrar sesión
            </a>
          </div>
        </div>

      </div>
    </header>

    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <% 
          // Helper para iniciales
          function initialsOf(str) {
            if (!str) return '';
            const s = String(str).toUpperCase();
            return (s[0] || '') + (s[1] || '');
          }
        %>

        <% if (typeof sidebarModules !== 'undefined') { %>
          <% sidebarModules.forEach(m => { 
               const label = m.customName || m.custom_name || m.name || m.slug; %>
            <a href="/apps/<%= m.slug %>" data-name="<%= label %>" data-slug="<%= m.slug %>" class="avatar avatar-modulo primary-20 open-module">
              <span class="avatar__text"><%= initialsOf(label) %></span>
            </a>
          <% }) %>
        <% } %>

        <!-- <div class="avatar secondary-20">
          <div class="mini-card secondary"></div>
        </div>

        <div class="avatar accent-20">
          <i data-lucide="check" class="icon-24 accent"></i>
        </div> -->

        <button class="avatar dashed primary-20" aria-label="Agregar">
          <i data-lucide="plus" class="icon-24 primary"></i>
        </button>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- SHELL (interfaz por encima del módulo) -->
        <div id="moduleShell" class="mod-shell" role="dialog" aria-modal="true" aria-label="Módulo">
          <header class="mod-shell__topbar">
            <div class="mod-shell__brand" aria-hidden="true"></div>
            <div class="mod-shell__title">Módulo: <span id="modTitle">—</span></div>
            <div class="mod-shell__muted" id="modStatus">· cargando…</div>
            <div class="mod-shell__spacer"></div>

            <!-- <a id="openNewTab" class="mod-shell__btn" target="_blank" rel="noopener noreferrer">
              <i data-lucide="external-link" class="icon-16"></i>
              <span class="mod-shell__btn-text">Abrir pestaña</span>
            </a> -->
            <button id="reloadFrame" class="mod-shell__btn mod-shell__btn--ghost">
              <i data-lucide="refresh-cw" class="icon-16"></i>
              <span class="mod-shell__btn-text">Recargar</span>
            </button>
            <button id="closeShell" class="mod-shell__btn mod-shell__btn--ghost" aria-label="Cerrar">
              <i data-lucide="x" class="icon-16"></i>
              <span class="mod-shell__btn-text">Cerrar</span>
            </button>
            <!-- <button id="modShellToggle" class="mod-shell__toggle" aria-expanded="true" aria-label="Contraer barra">
              <i data-lucide="chevron-up" class="icon-14"></i>
            </button> -->
          </header>
          <div class="mod-shell__framewrap">
            <iframe id="modFrame" class="mod-shell__frame" src="about:blank"
              allow="clipboard-read; clipboard-write"></iframe>
          </div>
        </div>

        <!-- Search bar -->
        <div class="toolbar">
          <div class="search">
            <i data-lucide="search" class="icon-16 muted absolute-left"></i>
            <input id="searchInput" type="text" placeholder="Buscar aplicación" class="input pl-10" />
          </div>
          <button class="btn btn-primary btn-icon rounded-12" aria-label="Nuevo">
            <i data-lucide="plus" class="icon-16"></i>
          </button>
        </div>

        <!-- =================== FAVORITOS =================== -->
        <section id="favorites-section" class="favorites-section" <%= (favorites && favorites.length) ? '' : 'hidden' %>>
          <h2 class="favorites-title">FAVORITOS</h2>
          <hr class="favorites-hr" />
          <div class="grid" id="grid-favorites">
            <% if (Array.isArray(favorites)) { %>
              <% favorites.forEach(m => { %>
               <% const label = m.customName || m.custom_name || m.name || m.slug %>
                <article class="card" data-slug="<%= m.slug %>" data-pref-state="favorito">
                  <div class="card__content">
                    <div class="tile secondary-30">
                      <i data-lucide="calendar" class="icon-32 secondary"></i>
                    </div>

                    <div>
                      <h3 class="card__title">
                        <%= label %>
                      </h3>
                      <p class="muted small">
                        <%= m.description %>
                      </p>
                    </div>

                    <!-- Acciones -->
                    <div class="card__kebab">
                      <button class="kebab-btn" aria-haspopup="menu" aria-expanded="false" aria-label="Más acciones"
                        data-menu-for="<%= m.slug %>">
                        <i data-lucide="more-vertical" class="icon-16"></i>
                      </button>

                      <div class="dropdown-menu" role="menu" id="menu-<%= m.slug %>" hidden>
                        <button class="dropdown-item danger add-favorite" role="menuitem" data-slug="<%= m.slug %>">
                          <i data-lucide="star-off" class="icon-16"></i>
                          Quitar de favoritos
                        </button>
                        <button class="dropdown-item danger not-interested" role="menuitem" data-slug="<%= m.slug %>">
                          <i data-lucide="eye-off" class="icon-16"></i>
                          No me interesa
                        </button>
                        <hr>
                        <button class="dropdown-item danger delete-module" role="menuitem" data-slug="<%= m.slug %>">
                          <i data-lucide="trash-2" class="icon-16"></i>
                          Eliminar módulo
                        </button>
                      </div>
                    </div>

                    <!-- Fallback / Abrir -->
                    <a href="/apps/<%= m.slug %>" class="btn chip secondary-70 open-module"
                      data-slug="<%= m.slug %>" data-name="<%= label %>">Abrir</a>
                  </div>
                </article>
              <% }) %>
            <% } %>
          </div>
        </section>
        <!-- =============== /FAVORITOS ===================== -->

        <!-- =================== NEUTRALES (grid original) =================== -->
        <% if (typeof all !== 'undefined' && all.length > 0) { %>
          <div class="grid" id="grid-modules">
            <% modules.forEach(m => { %>
              <% const label = m.customName || m.custom_name || m.name || m.slug %>
              <article class="card" data-slug="<%= m.slug %>" data-pref-state="neutral">
                <div class="card__content">
                  <div class="tile secondary-30">
                    <i data-lucide="calendar" class="icon-32 secondary"></i>
                  </div>

                  <div>
                    <h3 class="card__title">
                      <%= label %>
                    </h3>
                    <p class="muted small">
                      <%= m.description %>
                    </p>
                  </div>

                  <!-- Acciones -->
                  <div class="card__kebab">
                    <button class="kebab-btn" aria-haspopup="menu" aria-expanded="false" aria-label="Más acciones"
                      data-menu-for="<%= m.slug %>">
                      <i data-lucide="more-vertical" class="icon-16"></i>
                    </button>

                    <div class="dropdown-menu" role="menu" id="menu-<%= m.slug %>" hidden>
                      <button class="dropdown-item danger add-favorite" role="menuitem" data-slug="<%= m.slug %>">
                        <i data-lucide="star" class="icon-16"></i>
                        Agregar a favoritos
                      </button>
                      <button class="dropdown-item danger not-interested" role="menuitem" data-slug="<%= m.slug %>">
                        <i data-lucide="eye-off" class="icon-16"></i>
                        No me interesa
                      </button>
                      <hr>
                      <button class="dropdown-item danger delete-module" role="menuitem" data-slug="<%= m.slug %>">
                        <i data-lucide="trash-2" class="icon-16"></i>
                        Eliminar módulo
                      </button>
                    </div>
                  </div>

                  <!-- Fallback / Abrir -->
                  <a href="/apps/<%= m.slug %>" class="btn chip secondary-70 open-module"
                    data-slug="<%= m.slug %>" data-name="<%= label %>">Abrir</a>
                </div>
              </article>
            <% }) %>
          </div>

          <!-- =================== NO ME INTERESA =================== -->
          <section id="hidden-section" class="hidden-section" <%= (hidden && hidden.length) ? '' : 'hidden' %>>
            <h2 class="hidden-title">NO ME INTERESA</h2>
            <hr class="hidden-hr" />
            <div class="grid" id="grid-hidden">
              <% if (Array.isArray(hidden)) { %>
                <% hidden.forEach(m => { %>
                  <% const label = m.customName || m.custom_name || m.name || m.slug %>
                  <article class="card" data-slug="<%= m.slug %>" data-pref-state="escondido">
                    <div class="card__content">
                      <div class="tile secondary-30">
                        <i data-lucide="calendar" class="icon-32 secondary"></i>
                      </div>

                      <div>
                        <h3 class="card__title">
                          <%= label %>
                        </h3>
                        <p class="muted small">
                          <%= m.description %>
                        </p>
                      </div>

                      <!-- Acciones -->
                      <div class="card__kebab">
                        <button class="kebab-btn" aria-haspopup="menu" aria-expanded="false" aria-label="Más acciones"
                          data-menu-for="<%= m.slug %>">
                          <i data-lucide="more-vertical" class="icon-16"></i>
                        </button>

                        <div class="dropdown-menu" role="menu" id="menu-<%= m.slug %>" hidden>
                          <button class="dropdown-item danger add-favorite" role="menuitem" data-slug="<%= m.slug %>">
                            <i data-lucide="star" class="icon-16"></i>
                            Agregar a favoritos
                          </button>
                          <button class="dropdown-item danger not-interested" role="menuitem" data-slug="<%= m.slug %>">
                            <i data-lucide="eye" class="icon-16"></i>
                            Mostrar en la lista
                          </button>
                          <hr>
                          <button class="dropdown-item danger delete-module" role="menuitem" data-slug="<%= m.slug %>">
                            <i data-lucide="trash-2" class="icon-16"></i>
                            Eliminar módulo
                          </button>
                        </div>
                      </div>

                      <!-- Fallback / Abrir -->
                      <a href="/apps/<%= m.slug %>" class="btn chip secondary-70 open-module"
                        data-slug="<%= m.slug %>" data-name="<%= label %>">Abrir</a>
                    </div>
                  </article>
                <% }) %>
              <% } %>
            </div>
          </section>
          <!-- =============== /NO ME INTERESA =================== -->

        <% } else { %>
          <div class="main-message">
            <div>
              <img src="img/svg/no-modules.svg" alt="No hay modulos instalados">
            </div>
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-file-text w-16 h-16 text-muted-foreground mx-auto mb-4" aria-hidden="true">
                <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
                <path d="M10 9H8"></path>
                <path d="M16 13H8"></path>
                <path d="M16 17H8"></path>
              </svg>
              <p class="bold">No hay modulos instalados.</p>
              <p>Para instalar un módulo ahora, haz click en el botón <strong>+</strong> en la parte superior.</p>
            </div>
          </div>
        <% } %>

        <div class="main-message deleting-module hidden">
          <div>
            <img src="img/svg/loading.svg" alt="Cargando...">
          </div>
          <div>
            <img src="img/circle-loading.gif" class="loading-spinner-gif" alt="Cargando..." />
            <p class="bold">Eliminando módulo...</p>
            <p>Espera mientras se elimina el módulo. No cierres esta ventana.</p>
          </div>
        </div>

        <div class="main-message error-deleting-module hidden">
          <div>
            <img src="img/svg/500-internal-server-error.svg" alt="Error interno del servidor" class="error-icon">
          </div>
          <div>
            <h2 class="bold">No se pudo eliminar el módulo.</h2>
            <p>Ocurrio un error al intentar eliminar el módulo. Por favor, inténtalo de nuevo más tarde.</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal subir -->
  <div id="uploadModal" class="modal" aria-hidden="true">
    <div class="modal__overlay" data-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="uploadTitle"
      aria-describedby="uploadDesc">
      <header class="modal__header"> <i data-lucide="package-plus" class="icon-16"></i>
        <div class="modal__title" id="uploadTitle">Subir módulo</div>
        <div class="modal__spacer"></div> <button class="modal__close btn btn-ghost" type="button" data-close> <i
            data-lucide="x" class="icon-16"></i> Cerrar </button>
      </header>
      <form id="uploadModuleForm" class="modal__body" method="POST" action="/api/modules/install"
        enctype="multipart/form-data" novalidate>
        <img src="img/circle-loading.gif" style="display: block;margin: 0 auto;" class="loading-spinner-gif" id="zip-loading" hidden alt="Cargando..." />
        <p id="nameSuggestion" class="muted small" hidden style="margin-top:-2px;margin-bottom:10px;">Nombre <strong>sugerido</strong> para el módulo.</p>
        <div class="field" id="moduleNameDiv" hidden> 
          <label for="modName" class="label">Nombre del módulo</label> 
          <input id="modName" name="moduleName" class="input" type="text" placeholder="Ej: gestor-alumnos" minlength="3" required autocomplete="off" />
        </div>
        <div class="field" id="moduleDescDiv" hidden> 
          <label for="modDesc" class="label">Pequeña descripción</label> 
          <textarea id="modDesc" name="moduleDescription" name="description" class="textarea" maxlength="300" placeholder="Breve resumen (máx. 300 caracteres)"></textarea>
        </div>
        <div class="field"> <label class="label">ZIP del módulo</label>
          <!-- IMPORTANTE: usamos label for="zipFile" para abrir el selector sin JS extra --> <label id="zipDrop"
            class="dropzone" for="zipFile" tabindex="0" aria-controls="zipFile"> <i data-lucide="upload"
              class="icon-20"></i>
            <div><strong>Arrastrá y soltá</strong> el .zip aquí o hacé clic para elegir</div>
            <div id="fileName" class="dropzone__hint">Acepta solo .zip</div>
          </label> <input id="zipFile" name="file" class="file-hidden" type="file"
            accept=".zip,application/zip,application/x-zip-compressed" required /> </div> <!-- Barra de progreso -->
        <div id="uploadProgress" class="progress-wrap" hidden>
          <div class="progress-track" aria-hidden="true">
            <div id="progressBar" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"
              aria-valuenow="0"></div>
          </div>
          <div class="progress-meta"> <span><strong id="progressPct">0%</strong></span> <span id="progressBytes">0 /
              0</span> <span id="progressEta">ETA —</span> <button id="cancelUpload" type="button" class="btn btn-ghost"
              style="margin-left:auto;">Cancelar</button> </div>
        </div>
        <div class="modal__footer"> <button type="button" class="btn btn-ghost" data-close>Cancelar</button> <button
            id="submitBtn" type="submit" class="btn btn-primary">Subir módulo</button> </div>
      </form>
    </div>
  </div>

  <!-- Alertas -->
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
    document.addEventListener("DOMContentLoaded", (event) => {
      if (window.gsap && window.Draggable) {
        gsap.registerPlugin(Draggable);
      }
    });
  </script>

  <script src="js/flash.js"></script>
  <script src="js/toast.js"></script>
  <script src="js/userMenu.js"></script>
  <script src="js/modulesActions.js"></script>
  <script src="js/topbarToggle.js"></script>
  <script src="js/shell.js"></script>
  <script src="js/upload.js"></script>
  <script src="js/app.js"></script>
  <script src="js/activeMarker.js"></script>
  <script src="js/loadTooltips.js"></script>
</body>

</html>
