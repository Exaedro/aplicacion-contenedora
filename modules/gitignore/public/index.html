<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Alumnos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #0F171A;
            --card: #1b2529; 
            --color: #E6F2F0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0F171A;
            color: #E6F2F0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #77a9db;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: #ffffff2d;
            font-weight: 600;
            color: #fff;
        }
        
        tr:hover {
            background: #ffffff2d;
        }
        
        .cursos-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }
        
        .cursos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: var(--background);
            margin: 5% auto;
            padding: 30px;
            color: var(--color);
            background-color: var(--card);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #fff;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            color: #fff;
            border-radius: 5px;
            padding: 10px;
        }
        
        #alumnoInfo {
            color: #000;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üìö M√≥dulo de Alumnos</h1>
                <p class="subtitle">Gesti√≥n de alumnos del sistema</p>
            </div>
        <div class="header-right">
            <button class="btn btn-warning" onclick="openViewByCourse()" id="btnViewByCourse">üìã Ver por Curso</button>
            <button class="btn btn-success" onclick="openAddModal()" id="btnAddAlumno">‚ûï Agregar Alumno</button>
            <button class="btn" onclick="loadAlumnos()">üîÑ Recargar</button>
        </div>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Buscar por nombre, apellido o email..." onkeyup="filterAlumnos()">
        </div>
        
        <div id="content">
            <div class="loading">Cargando alumnos...</div>
        </div>
    </div>

    <!-- Modal Agregar Alumno -->
    <div id="modalAddAlumno" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Nuevo Alumno</h2>
                <button class="close" onclick="closeModal('modalAddAlumno')">&times;</button>
            </div>
            <form id="formAddAlumno" onsubmit="addAlumno(event)">
                <div class="form-group">
                    <label>Nombres *</label>
                    <input type="text" name="nombres" required>
                </div>
                <div class="form-group">
                    <label>Apellidos *</label>
                    <input type="text" name="apellidos" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a *</label>
                    <input type="password" name="contrasena" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Asignar Curso *</label>
                    <div class="checkbox-group" id="cursosCheckboxAdd" style="max-height: 150px;">
                        <div class="loading">Cargando cursos...</div>
                    </div>
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">Debe seleccionar exactamente un curso</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('modalAddAlumno')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ver por Curso -->
    <div id="modalViewByCourse" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Alumnos por Curso</h2>
                <button class="close" onclick="closeModal('modalViewByCourse')">&times;</button>
            </div>
            <div class="form-group">
                <label>Seleccionar Curso:</label>
                <select id="selectCurso" onchange="loadAlumnosByCourse()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">-- Seleccione un curso --</option>
                </select>
            </div>
            <div id="alumnosByCourseContent" style="margin-top: 20px;">
                <div class="empty">Seleccione un curso para ver los alumnos</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('modalViewByCourse')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Asignar Cursos -->
    <div id="modalAsignarCursos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Asignar Cursos</h2>
                <button class="close" onclick="closeModal('modalAsignarCursos')">&times;</button>
            </div>
            <div id="alumnoInfo" style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
            <div class="form-group">
                <label>Seleccionar Curso:</label>
                <div class="checkbox-group" id="cursosCheckbox">
                    <div class="loading">Cargando cursos...</div>
                </div>
                <small style="color: #7f8c8d; display: block; margin-top: 5px;">Solo puede seleccionar un curso</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('modalAsignarCursos')">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveCursos()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const slug = (window.location.pathname || '').split('/').filter(Boolean)[1] || '';
        const moduleBase = slug ? `/modulos/${slug}` : '';
        function moduleApi(p) { const normalized = p.startsWith('/') ? p.slice(1) : p; return `${moduleBase}/${normalized}`; }

        const API_BASE = moduleApi('api/alumnos');
        let alumnosData = [];
        let cursosDisponibles = [];
        let alumnoActualId = null;
        let userRole = null;
        
        // Cargar rol del usuario consultando el propio m√≥dulo (GET api/alumnos/me).
        // Usamos una ruta absoluta para asegurarnos de llamar al servidor contenedor
        // (no al servidor del m√≥dulo) ‚Äî el token est√° en cookie HTTP-only y
        // esta ruta devuelve la informaci√≥n m√≠nima del usuario.
        async function getUserRole() {
            try {
                const resp = await fetch(`${API_BASE}/me`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!resp.ok) return null;
                const json = await resp.json();
                return json.user?.role || null;
            } catch (err) {
                console.error('Error al obtener rol del usuario:', err);
                return null;
            }
        }
        
        async function loadAlumnos() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Cargando alumnos...</div>';
            
            try {
                const response = await fetch(API_BASE, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        content.innerHTML = '<div class="error">‚ùå No est√°s autenticado. Por favor, inicia sesi√≥n en el sistema principal.</div>';
                        return;
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                alumnosData = data.alumnos || [];
                
                if (alumnosData.length > 0) {
                    renderTable(alumnosData);
                } else {
                    content.innerHTML = '<div class="empty">üì≠ No hay alumnos registrados</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå Error al cargar alumnos: ${error.message}</div>`;
                console.error('Error:', error);
            }
        }
        
        function renderTable(alumnos) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombres</th>
                                <th>Apellidos</th>
                                <th>Email</th>
                                <th>Cursos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${alumnos.map(alumno => `
                                <tr>
                                    <td>${alumno.id}</td>
                                    <td>${alumno.nombres}</td>
                                    <td>${alumno.apellidos}</td>
                                    <td>${alumno.email}</td>
                                    <td>
                                        <div class="cursos-container">
                                            ${alumno.cursos && alumno.cursos.length > 0 
                                                ? alumno.cursos.map(curso => `<span class="cursos-badge">${curso.nombre}</span>`).join('')
                                                : '<span style="color: #999;">Sin cursos</span>'
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        ${ (userRole === 'admin' || userRole === 'preceptor') ? `
                                            <button class="btn btn-warning btn-sm" onclick="openAsignarCursos(${alumno.id}, '${alumno.nombres} ${alumno.apellidos}')">
                                                üìö Cursos
                                            </button>
                                        ` : '<span style="color:#999; font-size:12px;">Sin permisos</span>' }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function filterAlumnos() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = alumnosData.filter(alumno => 
                alumno.nombres.toLowerCase().includes(searchTerm) ||
                alumno.apellidos.toLowerCase().includes(searchTerm) ||
                alumno.email.toLowerCase().includes(searchTerm)
            );
            renderTable(filtered);
        }
        
        async function openAddModal() {
            document.getElementById('modalAddAlumno').style.display = 'block';
            document.getElementById('formAddAlumno').reset();
            
            // Asegurarse de que el bot√≥n est√© en su estado inicial
            const submitBtn = document.querySelector('#formAddAlumno button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Agregar';
            }
            
            // Cargar cursos disponibles para el formulario
            await loadCursosForAdd();
        }
        
        async function loadCursosForAdd() {
            try {
                const response = await fetch(`${API_BASE}/cursos/disponibles`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Error al cargar cursos');
                
                const data = await response.json();
                const cursos = data.cursos || [];
                
                const checkboxContainer = document.getElementById('cursosCheckboxAdd');
                checkboxContainer.innerHTML = cursos.map(curso => `
                    <div class="checkbox-item">
                        <input type="radio" name="curso_alumno" id="curso_add_${curso.id}" value="${curso.id}" required>
                        <label for="curso_add_${curso.id}">${curso.nombre}</label>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('cursosCheckboxAdd').innerHTML = 
                    `<div class="error">Error al cargar cursos: ${error.message}</div>`;
            }
        }
        
        async function openViewByCourse() {
            document.getElementById('modalViewByCourse').style.display = 'block';
            
            // Cargar cursos disponibles
            try {
                const response = await fetch(`${API_BASE}/cursos/disponibles`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Error al cargar cursos');
                
                const data = await response.json();
                const cursos = data.cursos || [];
                
                const select = document.getElementById('selectCurso');
                select.innerHTML = '<option value="">-- Seleccione un curso --</option>' +
                    cursos.map(curso => `<option value="${curso.id}">${curso.nombre}</option>`).join('');
            } catch (error) {
                document.getElementById('alumnosByCourseContent').innerHTML = 
                    `<div class="error">Error al cargar cursos: ${error.message}</div>`;
            }
        }
        
        async function loadAlumnosByCourse() {
            const cursoId = document.getElementById('selectCurso').value;
            const content = document.getElementById('alumnosByCourseContent');
            
            if (!cursoId) {
                content.innerHTML = '<div class="empty">Seleccione un curso para ver los alumnos</div>';
                return;
            }
            
            content.innerHTML = '<div class="loading">Cargando alumnos...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/cursos/${cursoId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    content.innerHTML = `<div class="error">Error: ${error.error || 'No se pudieron cargar los alumnos'}</div>`;
                    return;
                }
                
                const data = await response.json();
                
                if (data.alumnos && data.alumnos.length > 0) {
                    content.innerHTML = `
                        <h3 style="margin-bottom: 15px;">Curso: ${data.curso.nombre}</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombres</th>
                                        <th>Apellidos</th>
                                        <th>Email</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.alumnos.map(alumno => `
                                        <tr>
                                            <td>${alumno.id}</td>
                                            <td>${alumno.nombres}</td>
                                            <td>${alumno.apellidos}</td>
                                            <td>${alumno.email}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <p style="margin-top: 15px; color: #7f8c8d;">Total: ${data.alumnos.length} alumno(s)</p>
                    `;
                } else {
                    content.innerHTML = `
                        <h3 style="margin-bottom: 15px;">Curso: ${data.curso.nombre}</h3>
                        <div class="empty">No hay alumnos asignados a este curso</div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `<div class="error">Error al cargar alumnos: ${error.message}</div>`;
                console.error('Error:', error);
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        async function addAlumno(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Obtener curso seleccionado (radio button)
            const cursoRadio = document.querySelector('#cursosCheckboxAdd input[type="radio"]:checked');
            
            if (!cursoRadio) {
                alert('‚ùå Error: Debe seleccionar un curso para el alumno');
                return;
            }
            
            const curso_id = parseInt(cursoRadio.value);
            const curso_ids = [curso_id]; // Enviar como array con un solo elemento
            
            const data = {
                nombres: formData.get('nombres'),
                apellidos: formData.get('apellidos'),
                email: formData.get('email'),
                contrasena: formData.get('contrasena'),
                curso_ids: curso_ids
            };
            
            // Mostrar loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';
            
            try {
                console.log('[Frontend] Enviando datos para crear alumno:', data);
                
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log('[Frontend] Response status:', response.status, response.statusText);
                
                let responseData;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`Respuesta no es JSON: ${text.substring(0, 100)}`);
                }
                
                console.log('[Frontend] Response data:', responseData);
                
                if (!response.ok) {
                    const errorMsg = responseData.error || responseData.message || `Error ${response.status}: ${response.statusText}`;
                    alert(`‚ùå Error: ${errorMsg}`);
                    console.error('[Frontend] Error completo:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: responseData
                    });
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                // √âxito
                console.log('[Frontend] ‚úÖ Alumno creado exitosamente');
                // Restaurar el bot√≥n antes de cerrar el modal
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                alert('‚úÖ Alumno agregado correctamente');
                closeModal('modalAddAlumno');
                loadAlumnos();
            } catch (error) {
                console.error('[Frontend] Error en catch:', error);
                alert('‚ùå Error al agregar alumno: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function openAsignarCursos(alumnoId, alumnoNombre) {
            alumnoActualId = alumnoId;
            document.getElementById('alumnoInfo').textContent = `Alumno: ${alumnoNombre}`;
            document.getElementById('modalAsignarCursos').style.display = 'block';
            
            // Cargar cursos disponibles
            await loadCursosDisponibles();
            
            // Cargar cursos actuales del alumno
            await loadCursosAlumno(alumnoId);
        }
        
        async function loadCursosDisponibles() {
            try {
                const response = await fetch(`${API_BASE}/cursos/disponibles`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Error al cargar cursos');
                
                const data = await response.json();
                cursosDisponibles = data.cursos || [];
                
                const checkboxContainer = document.getElementById('cursosCheckbox');
                checkboxContainer.innerHTML = cursosDisponibles.map(curso => `
                    <div class="checkbox-item">
                        <input type="radio" name="curso_asignar" id="curso_${curso.id}" value="${curso.id}">
                        <label for="curso_${curso.id}">${curso.nombre}</label>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('cursosCheckbox').innerHTML = 
                    `<div class="error">Error al cargar cursos: ${error.message}</div>`;
            }
        }
        
        async function loadCursosAlumno(alumnoId) {
            try {
                const response = await fetch(`${API_BASE}/${alumnoId}/cursos`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const cursosAsignados = data.cursos || [];
                
                // Marcar radio button del curso asignado (solo el primero si hay m√°s de uno)
                if (cursosAsignados.length > 0) {
                    const curso = cursosAsignados[0];
                    const radio = document.getElementById(`curso_${curso.id}`);
                    if (radio) radio.checked = true;
                }
            } catch (error) {
                console.error('Error al cargar cursos del alumno:', error);
            }
        }
        
        async function saveCursos() {
            const radio = document.querySelector('#cursosCheckbox input[type="radio"]:checked');
            
            if (!radio) {
                alert('‚ùå Error: Debe seleccionar un curso');
                return;
            }
            
            const cursoId = parseInt(radio.value);
            const cursoIds = [cursoId]; // Enviar como array con un solo elemento
            
            const saveBtn = document.querySelector('#modalAsignarCursos .btn-success');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            
            try {
                console.log('[Frontend] Asignando curso:', { alumnoId: alumnoActualId, cursoId });
                
                const response = await fetch(`${API_BASE}/${alumnoActualId}/cursos`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curso_ids: cursoIds })
                });
                
                console.log('[Frontend] Response status:', response.status, response.statusText);
                
                let responseData;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(`Respuesta no es JSON: ${text.substring(0, 100)}`);
                }
                
                console.log('[Frontend] Response data:', responseData);
                
                if (!response.ok) {
                    const errorMsg = responseData.error || responseData.message || `Error ${response.status}: ${response.statusText}`;
                    alert(`‚ùå Error: ${errorMsg}`);
                    console.error('[Frontend] Error completo:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: responseData
                    });
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    return;
                }
                
                // √âxito
                console.log('[Frontend] ‚úÖ Cursos asignados exitosamente');
                alert('‚úÖ Cursos asignados correctamente');
                closeModal('modalAsignarCursos');
                loadAlumnos();
            } catch (error) {
                console.error('[Frontend] Error en catch:', error);
                alert('‚ùå Error al asignar cursos: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }
        
        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        };
        
        // Cargar rol y luego alumnos al iniciar
        (async () => {
            userRole = await getUserRole();
            // Mostrar/ocultar bot√≥n de agregar seg√∫n permisos
            const addBtn = document.getElementById('btnAddAlumno');
            if (addBtn) addBtn.style.display = (userRole === 'admin' || userRole === 'preceptor') ? 'inline-flex' : 'none';

            loadAlumnos();
        })();
    </script>
</body>
</html>
